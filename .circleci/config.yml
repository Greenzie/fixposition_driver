version: 2.1

workflows:
  version: 2
  pushbuild:
    jobs:
      - debian_build:
          name: "amd_debian_build"
          parameters:
            resource_class: small
            platform: amd64

      - debian_build:
          name: "arm_debian_build"
          parameters:
            resource_class: arm.medium
            platform: arm64

      - deploy:
          filters:
            branches:
              only:
                - noetic
          requires:
            - amd_debian_build

jobs:
  debian_build:
    docker:
      - image: greenzie/debianize-experimental:focal-noetic
        auth:
          username: $DOCKERHUB_GREENZIE_USERNAME
          password: $DOCKERHUB_GREENZIE_PASSWORD
    resource_class: << parameters.resource_class >>
    parameters:
      resource_class:
        type: string
        default: small
      platform:
        type: string
        default: amd64
    steps:
      - checkout
      - run:
          name: "Generate Changelogs"
          command: greenzie-release changelog -r "${ROS_DISTRO}"
      - run:
          name: "Package debs (debuild)"
          environment:
            - TARGETPLATFORM = << parameters.platform >>
          command: GITHUB_WORKSPACE="$PWD" greenzie-debianize all
      - store_artifacts:
          path: /debians
      - persist_to_workspace:
          root: /debians
          paths:
            - '*'

  deploy:
    docker:
      - image: greenzie/aptly:3.19.1-focal-noetic
        auth:
          username: $DOCKERHUB_GREENZIE_USERNAME
          password: $DOCKERHUB_GREENZIE_PASSWORD
    resource_class: small
    steps:
      - add_ssh_keys
      - attach_workspace:
          at: /debians
      - run:
          name: Deploy to aptly.greenzie.com
          environment:
            SERVER_HOSTNAME: aptly.greenzie.com
          command: |
            aptly repo deploy -r experimental -n "${CIRCLE_BUILD_NUM}" -p "/debians"
